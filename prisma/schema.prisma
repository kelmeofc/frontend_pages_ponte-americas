generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("PRISMA_DATABASE_URL")
  directUrl         = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Lead {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(100)
  email       String? @db.VarChar(255)
  phoneNumber String? @db.VarChar(20) @map("phone_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relationships
  leadSubmissions LeadSubmission[]

  @@index([email])
  @@index([createdAt])
  @@map("leads")
}

model LeadSubmission {
  id       Int            @id @default(autoincrement())
  leadId   Int            @map("lead_id")
  type     LeadSubmissionType
  success  Boolean
  data     Json // Form submission data
  metadata Json           @default("{}") // Request metadata

  // Location and tracking data
  city       String?  @db.VarChar(100)
  country    String?  @db.VarChar(100)
  ipAddress  String?  @db.Inet @map("ip_address")
  route      String?  @db.VarChar(500)
  userAgent  String?  @db.Text @map("user_agent")
  origin     Int
  originFont String?  @db.VarChar(100) @map("origin_font")

  createdAt DateTime @default(now()) @map("created_at")

  // Relationships
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([type])
  @@index([origin])
  @@index([createdAt])
  @@index([type, createdAt])
  @@index([leadId, type])
  @@map("lead_submissions")
}

enum EnrollmentStatus {
  IDENTIFICATION_PENDING
  IDENTIFICATION_COMPLETED
  PAYMENT_ATTEMPTED
  WAITLISTED
  ENROLLED
}

enum LeadSubmissionType {
  EBOOK_DOWNLOAD
  ENROLLMENT_ATTEMPT
}

model User {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(100)
  email       String  @unique @db.VarChar(255)
  phoneNumber String? @db.VarChar(20) @map("phone_number")
  password    String  @db.VarChar(255)

  // Enrollment specific fields
  enrollmentStatus EnrollmentStatus @default(IDENTIFICATION_PENDING) @map("enrollment_status")

  // Location and metadata
  city       String?  @db.VarChar(100)
  country    String?  @db.VarChar(100)
  ipAddress  String?  @db.Inet @map("ip_address")
  route      String?  @db.VarChar(500)
  userAgent  String?  @db.Text @map("user_agent")
  origin     Int      @default(6) // EOriginLead.page
  originFont String?  @db.VarChar(100) @map("origin_font")

  // Timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  enrolledAt DateTime? @map("enrolled_at")

  // Relationships
  userSubmissions          UserSubmission[]
  userRegistrationProgress UserRegistrationProgress[]

  @@index([email])
  @@index([enrollmentStatus])
  @@index([createdAt])
  @@index([enrollmentStatus, createdAt])
  @@map("users")
}

model UserSubmission {
  id        Int                @id @default(autoincrement())
  userId    Int                @map("user_id")
  type      UserSubmissionType
  success   Boolean
  data      Json // Form submission data
  metadata  Json               @default("{}") // Request metadata
  createdAt DateTime           @default(now()) @map("created_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("user_submissions")
}

model UserRegistrationProgress {
  id               Int       @id @default(autoincrement())
  userId           Int       @map("user_id")
  registrationStep Int       @map("registration_step")
  stepName         String    @db.VarChar(100) @map("step_name")
  completed        Boolean   @default(false)
  completedAt      DateTime? @map("completed_at")
  validationData   Json?     @map("validation_data")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, registrationStep], name: "unique_user_registration_step")
  @@index([userId, completed])
  @@map("user_registration_progress")
}

enum UserSubmissionType {
  ENROLLMENT_ATTEMPT
  PAYMENT_ATTEMPT
  IDENTIFICATION_SUBMISSION
}


